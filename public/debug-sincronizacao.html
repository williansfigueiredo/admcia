<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Debug - SincronizaÃ§Ã£o Job â†’ TransaÃ§Ã£o</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #667eea;
            margin-top: 0;
            font-size: 18px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        .badge-pendente {
            background: rgba(255, 193, 7, 0.2);
            color: #ff6b00;
        }
        .badge-atrasado {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        .badge-pago {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .instruction {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #ffc107;
            margin: 20px 0;
        }
        .instruction strong {
            color: #856404;
        }
        input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-right: 10px;
            width: 100px;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .flex {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .flex > div {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Debug de SincronizaÃ§Ã£o</h1>
        <p class="subtitle">Verificar se mudanÃ§as no pagamento do Job refletem na TransaÃ§Ã£o</p>

        <div class="instruction">
            <strong>ğŸ“‹ INSTRUÃ‡Ã•ES:</strong><br>
            1. VÃ¡ em <strong>GestÃ£o de Contratos</strong><br>
            2. Encontre o Job "ConvenÃ§Ã£o FLORA" (ou qualquer outro)<br>
            3. <strong>Mude o status de PAGAMENTO</strong> (ex: de Pendente â†’ Vencido)<br>
            4. <strong>VOLTE AQUI</strong> e clique em "Verificar SincronizaÃ§Ã£o"<br>
            5. Compare os status abaixo
        </div>

        <div class="section">
            <h2>ğŸ¯ 1. Buscar Job pelo ID</h2>
            <label>Job ID: <input type="number" id="jobId" value="1" min="1"></label>
            <button onclick="buscarJob()">ğŸ” Buscar Job</button>
            <div id="resultJob" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>ğŸ’° 2. Buscar TransaÃ§Ã£o Relacionada</h2>
            <button onclick="buscarTransacao()">ğŸ” Buscar TransaÃ§Ã£o do Job</button>
            <div id="resultTransacao" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>ğŸ”„ 3. Comparar Status</h2>
            <button onclick="compararStatus()">âš–ï¸ Verificar SincronizaÃ§Ã£o</button>
            <div id="resultComparacao" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>ğŸ”¥ 4. Teste Direto no Banco</h2>
            <button onclick="consultarBanco()">ğŸ—„ï¸ Consultar Banco de Dados</button>
            <div id="resultBanco" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://admcia-production.up.railway.app';

        let jobAtual = null;
        let transacaoAtual = null;

        async function buscarJob() {
            const jobId = document.getElementById('jobId').value;
            const result = document.getElementById('resultJob');
            
            result.style.display = 'block';
            result.innerHTML = 'â³ Carregando...';

            try {
                const response = await fetch(`${API_URL}/jobs/${jobId}`);
                const data = await response.json();
                
                if (data.error) {
                    result.innerHTML = `âŒ Erro: ${data.error}`;
                    return;
                }

                jobAtual = data;
                
                result.innerHTML = `
âœ… JOB ENCONTRADO:

ğŸ“‹ DescriÃ§Ã£o: ${data.descricao}
ğŸ†” ID: ${data.id}
ğŸ“Š Status: ${data.status}
ğŸ’° Pagamento: ${data.pagamento}
ğŸ“… Vencimento: ${data.data_vencimento ? new Date(data.data_vencimento).toLocaleDateString('pt-BR') : 'N/A'}

<span class="status-badge badge-${data.pagamento.toLowerCase()}">${data.pagamento}</span>
                `;
            } catch (error) {
                result.innerHTML = `âŒ Erro na requisiÃ§Ã£o: ${error.message}`;
            }
        }

        async function buscarTransacao() {
            const jobId = document.getElementById('jobId').value;
            const result = document.getElementById('resultTransacao');
            
            result.style.display = 'block';
            result.innerHTML = 'â³ Carregando...';

            try {
                const response = await fetch(`${API_URL}/financeiro/transacoes?busca=Job #${jobId}`);
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    result.innerHTML = `âš ï¸ NENHUMA TRANSAÃ‡ÃƒO ENCONTRADA para Job #${jobId}`;
                    return;
                }

                const transacoes = Array.isArray(data) ? data.filter(t => t.job_id == jobId) : [];
               
                if (transacoes.length === 0) {
                    result.innerHTML = `âš ï¸ NENHUMA TRANSAÃ‡ÃƒO com job_id = ${jobId}`;
                    return;
                }

                transacaoAtual = transacoes[0];
                
                result.innerHTML = `
âœ… TRANSAÃ‡ÃƒO ENCONTRADA:

ğŸ“‹ DescriÃ§Ã£o: ${transacaoAtual.descricao}
ğŸ†” ID: ${transacaoAtual.id}
ğŸ”— Job ID: ${transacaoAtual.job_id}
ğŸ“Š Status: ${transacaoAtual.status}
ğŸ’µ Valor: R$ ${parseFloat(transacaoAtual.valor).toFixed(2)}
ğŸ“… Vencimento: ${transacaoAtual.data_vencimento ? new Date(transacaoAtual.data_vencimento).toLocaleDateString('pt-BR') : 'N/A'}

<span class="status-badge badge-${transacaoAtual.status}">${transacaoAtual.status.toUpperCase()}</span>
                `;
            } catch (error) {
                result.innerHTML = `âŒ Erro na requisiÃ§Ã£o: ${error.message}`;
            }
        }

        async function compararStatus() {
            if (!jobAtual || !transacaoAtual) {
                alert('âš ï¸ Execute as buscas 1 e 2 primeiro!');
                return;
            }

            const result = document.getElementById('resultComparacao');
            result.style.display = 'block';

            const mapeamento = {
                'Pago': 'pago',
                'Faturado': 'pago',
                'Pendente': 'pendente',
                'Vencido': 'atrasado',
                'Cancelado': 'cancelado'
            };

            const statusEsperado = mapeamento[jobAtual.pagamento] || 'desconhecido';
            const statusReal = transacaoAtual.status;
            const sincronizado = statusEsperado === statusReal;

            result.innerHTML = `
ğŸ” COMPARAÃ‡ÃƒO:

ğŸ“Š Status do Job (Pagamento): ${jobAtual.pagamento}
   â†“ (deve mapear para)
ğŸ’° Status da TransaÃ§Ã£o: ${statusReal}

âœ¨ Status Esperado: ${statusEsperado}
âœ¨ Status Real: ${statusReal}

${sincronizado 
    ? 'âœ… SINCRONIZADO âœ…' 
    : 'âŒ DESSINCRONIZADO âŒ\n\nâš ï¸ PROBLEMA DETECTADO!\nO status da transaÃ§Ã£o nÃ£o corresponde ao status de pagamento do job.'
}

---

ğŸ”§ MAPEAMENTO CORRETO:
   Pago/Faturado â†’ pago
   Pendente â†’ pendente
   Vencido â†’ atrasado
   Cancelado â†’ cancelado
            `;
        }

        async function consultarBanco() {
            const result = document.getElementById('resultBanco');
            result.style.display = 'block';
            result.innerHTML = `
âš ï¸ CONSULTA DIRETA AO BANCO

Para verificar diretamente no banco de dados MySQL, use:

1ï¸âƒ£ Verificar o Job:
   SELECT id, descricao, pagamento, status, data_vencimento 
   FROM jobs 
   WHERE id = ${document.getElementById('jobId').value};

2ï¸âƒ£ Verificar a TransaÃ§Ã£o:
   SELECT id, descricao, status, valor, data_vencimento, job_id 
   FROM transacoes 
   WHERE job_id = ${document.getElementById('jobId').value};

3ï¸âƒ£ Verificar a sincronizaÃ§Ã£o:
   SELECT 
     j.id as job_id,
     j.descricao as job_descricao,
     j.pagamento as job_pagamento,
     t.id as transacao_id,
     t.status as transacao_status
   FROM jobs j
   LEFT JOIN transacoes t ON j.id = t.job_id
   WHERE j.id = ${document.getElementById('jobId').value};

---

ğŸ”´ Se aparecer NULL na transacao_id, significa que a transaÃ§Ã£o NÃƒO FOI CRIADA!
            `;
        }

        // Auto-busca ao carregar a pÃ¡gina
        window.onload = () => {
            console.log('ğŸ” PÃ¡gina de debug carregada');
            console.log('ğŸ“¡ API URL:', API_URL);
        };
    </script>
</body>
</html>
